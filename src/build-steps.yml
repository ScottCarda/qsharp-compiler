##
# Build, test and pack the compiler
##
steps:

- task: DotNetCoreCLI@2
  displayName: 'Build and test Q# compiler'
  inputs:
    command: test
    arguments: '-c $(BuildConfiguration) -v $(Build.Verbosity)  /p:DefineConstants=$(Assembly.Constants) /p:Version=$(Assembly.Version)'
    projects: '$(CompilerSrcDir)/../QsCompiler.sln'


- task: NuGetCommand@2
  displayName: 'Pack Q# compiler'
  inputs:
    command: pack
    packagesToPack: >
      src\QsCompiler\Compiler\QsCompiler.csproj;
    versioningScheme: byEnvVar
    versionEnvVar: NUGET_VERSION
    packDestination: '$(System.DefaultWorkingDirectory)'
    includeReferencedProjects: true
    

- task: DotNetCoreCLI@2
  displayName: 'Publish Q# command line compiler'
  inputs:
    command: publish
    arguments: '-c $(BuildConfiguration) -v $(Build.Verbosity)  /p:DefineConstants=$(Assembly.Constants) /p:Version=$(Assembly.Version)'
    publishWebProjects: false
    projects: $(CompilerSrcDir)/CommandLineTool/QsCommandLineTool.csproj
    zipAfterPublish: false
    modifyOutputPath: false


- task: DotNetCoreCLI@2
  displayName: 'Publish Q# language server'
  inputs:
    command: publish
    arguments: '-c $(BuildConfiguration) -v $(Build.Verbosity)  /p:DefineConstants=$(Assembly.Constants) /p:Version=$(Assembly.Version)'
    publishWebProjects: false
    projects: $(CompilerSrcDir)/LanguageServer/QsLanguageServer.csproj
    zipAfterPublish: false
    modifyOutputPath: false
